(window.webpackJsonp=window.webpackJsonp||[]).push([[5,1],[,,,function(e,t,s){"use strict";function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.r(t),s.d(t,"default",(function(){return i}));class i{constructor(e){n(this,"element",void 0),n(this,"subElements",{}),n(this,"components",{})}async render(){return this.element=document.createElement("div"),this.element.innerHTML=this.template,this.element=this.element.firstElementChild,this.subElements=this.getSubElements(this.element),this.components=await this.getComponents(),Object.keys(this.components).forEach(e=>{this.subElements[e].append(this.components[e].element)}),this.initEventListeners(),this.element}initEventListeners(){}get template(){return"<div></div>"}getSubElements(e){const t={};for(const s of e.querySelectorAll("[data-element]"))t[s.dataset.element]=s;return t}async getComponents(){return{}}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null,this.subElements={},Object.values(this.components).forEach(e=>e.destroy()),this.components={}}}},,function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return h}));var n=s(3),i=s(15),r=s(11),o=s(13),a=s(12),l=s.p+"components/product-form/icon-grab.svg",c=s.p+"components/product-form/icon-trash.svg",u=s(10);function d(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class m{constructor(e){d(this,"element",void 0),d(this,"subElements",{}),d(this,"onUploadImage",()=>{let e=document.getElementById("imageUpload");e||(e=document.createElement("input"),e.id="imageUpload",e.type="file",e.accept="image/*",e.hidden=!0,e.addEventListener("change",this.onChange),this.element.append(e)),e.click()}),d(this,"onChange",e=>{const[t]=e.target.files;if(!t)return;this.disableImageUpload();const s=new FormData;s.append("image",t),Object(a.a)(u.f,{method:"POST",headers:{Authorization:"Client-ID "+u.e},body:s,referrer:""}).then(e=>this.addImage({url:e.data.link,source:t.name})).catch(e=>new r.a(e.message,{type:u.h.error}).show()).finally(()=>this.enableImageUpload())}),d(this,"onSubmit",e=>{e.preventDefault(),this.save().then(()=>new r.a("Товар сохранен!",{type:u.h.success}).show()).catch(e=>new r.a(e.message,{type:u.h.error}).show())}),this.productId=e,this.defaultData={title:"",description:"",price:100,quantity:1,discount:0,status:1,images:[]},this.render().catch(e=>new r.a(e.message,{type:u.h.error}).show())}async loadCategories(){const e=new URL(u.c,u.a);return e.searchParams.set("_sort","weight"),e.searchParams.set("_refs","subcategory"),await Object(a.a)(e)}async loadProduct(e){const t=new URL(u.k,u.a);return t.searchParams.set("id",e),await Object(a.a)(t)}async loadData(){const[e,t]=await Promise.all([this.loadCategories(),this.productId?this.loadProduct(this.productId):Promise.resolve([this.defaultData])]);this.setCategories(e);const[s]=t;this.setProductData(s)}async render(){this.element=document.createElement("div"),this.element.innerHTML=this.template,this.element=this.element.firstElementChild,this.subElements=this.getSubElements(this.element),await this.loadData(),this.initEventListeners()}async save(){const[e,t]=this.productId?["PATCH","product-updated"]:["PUT","product-saved"],s=await Object(a.a)(new URL(u.k,u.a),{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify(this.getProductData())});this.element.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:{response:s}}))}initEventListeners(){this.subElements.productForm.elements.uploadImage.addEventListener("click",this.onUploadImage),this.subElements.productForm.addEventListener("submit",this.onSubmit)}get template(){return"\n      <div class='product-form'>\n        <form data-element='productForm' class='form-grid'>\n          <div class='form-group form-group__half_left'>\n            <fieldset>\n              <label class='form-label'>Название товара</label>\n              <input required='' type='text' name='title' id='title' class='form-control' placeholder='Название товара'>\n            </fieldset>\n          </div>\n          <div class='form-group form-group__wide'>\n            <label class='form-label'>Описание</label>\n            <textarea required='' class='form-control' name='description' id='description' placeholder='Описание товара'></textarea>\n          </div>\n          <div class='form-group form-group__wide'>\n            <label class='form-label'>Фото</label>\n            <div data-element='imageList'></div>\n            <button type='button' name='uploadImage' class='button-primary-outline fit-content'><span>Загрузить</span></button>\n          </div>\n          <div class='form-group form-group__half_left'>\n            <label class='form-label'>Категория</label>\n            <select class='form-control' name='subcategory' id='subcategory'></select>\n          </div>\n          <div class='form-group form-group__half_left form-group__two-col'>\n            <fieldset>\n              <label class='form-label'>Цена ($)</label>\n              <input required='' type='number' name='price' id='price' class='form-control' placeholder='100'>\n            </fieldset>\n            <fieldset>\n              <label class='form-label'>Скидка ($)</label>\n              <input required='' type='number' name='discount' id='discount' class='form-control' placeholder='0'>\n            </fieldset>\n          </div>\n          <div class='form-group form-group__part-half'>\n            <label class='form-label'>Количество</label>\n            <input required='' type='number' class='form-control' name='quantity' id='quantity' placeholder='1'>\n          </div>\n          <div class='form-group form-group__part-half'>\n            <label class='form-label'>Статус</label>\n            <select class='form-control' name='status' id='status'>\n              <option value='1'>Активен</option>\n              <option value='0'>Неактивен</option>\n            </select>\n          </div>\n          <div class='form-buttons'>\n            <button type='submit' name='save' class='button-primary-outline'>\n              Сохранить товар\n            </button>\n          </div>\n        </form>\n      </div>\n    "}setCategories(e){const t=[];e.forEach(e=>{e.subcategories.forEach(s=>{t.push({id:s.id,text:e.title+" > "+s.title})})}),this.subElements.productForm.elements.subcategory.innerHTML=t.map(({id:e,text:t})=>`\n        <option value="${e}">${Object(o.a)(t)}</option>\n      `).join("")}createImageList(e){return new i.a({items:e.map(e=>this.createImageListItem(e))}).element}createImageListItem({url:e,source:t}){const s=document.createElement("div");return s.innerHTML=`\n      <li class='products-edit__imagelist-item sortable-list__item'>\n        <input type="hidden" name="url" value="${e}">\n        <input type="hidden" name="source" value="${t}">\n        <span>\n           <img src="${l}" data-grab-handle="" alt="grab">\n           <img class="sortable-table__cell-img" alt="Image" src="${e}"><span>${t}</span>\n        </span>\n        <button type="button">\n           <img src="${c}" data-delete-handle="" alt="delete">\n        </button>\n      </li>\n    `,s.firstElementChild}disableImageUpload(){this.subElements.productForm.elements.uploadImage.classList.add("is-loading"),this.subElements.productForm.elements.uploadImage.disabled=!0}enableImageUpload(){this.subElements.productForm.elements.uploadImage.classList.remove("is-loading"),this.subElements.productForm.elements.uploadImage.disabled=!1}addImage(e){const t=this.getImages();t.push(e),this.setImages(t)}getImages(){const e=[];return this.subElements.imageList.querySelectorAll(".sortable-list__item").forEach(t=>{const s=t.querySelector('input[name="url"]').value,n=t.querySelector('input[name="source"]').value;e.push({url:s,source:n})}),e}setImages(e){this.subElements.imageList.replaceChildren(this.createImageList(e))}getSubElements(e){const t={};for(const s of e.querySelectorAll("[data-element]"))t[s.dataset.element]=s;return t}getProductData(){const e=this.subElements.productForm.elements,t={title:e.title.value,description:e.description.value,subcategory:e.subcategory.value,price:Number(e.price.value),quantity:Number(e.quantity.value),discount:Number(e.discount.value),status:Number(e.status.value),images:this.getImages()};return this.productId&&(t.id=this.productId),t}setProductData(e){const t=this.subElements.productForm.elements;t.title.value=e.title,t.description.value=e.description,e.subcategory&&(t.subcategory.value=e.subcategory),t.price.value=e.price,t.quantity.value=e.quantity,t.discount.value=e.discount,t.status.value=e.status,this.setImages(e.images)}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null,this.subElements={}}}class h extends n.default{constructor(e){super(e),this.productId=e[1]}async getComponents(){return{productForm:new m(this.productId)}}get template(){return`\n      <div class="products-edit">\n        <div class="content__top-panel">\n          <h1 class="page-title">\n            <a href="/project-structure/products" class="link">Товары</a> / ${this.productId?"Редактировать":"Добавить"}\n          </h1>\n        </div>\n        <div class="content-box">\n          <div data-element="productForm"></div>\n        </div>\n      </div>\n    `}}},,,,,function(e,t,s){"use strict";s.d(t,"j",(function(){return n})),s.d(t,"l",(function(){return i})),s.d(t,"d",(function(){return r})),s.d(t,"b",(function(){return o})),s.d(t,"k",(function(){return a})),s.d(t,"c",(function(){return l})),s.d(t,"m",(function(){return c})),s.d(t,"i",(function(){return u})),s.d(t,"a",(function(){return d})),s.d(t,"f",(function(){return m})),s.d(t,"e",(function(){return h})),s.d(t,"g",(function(){return p})),s.d(t,"h",(function(){return g}));const n="api/dashboard/orders",i="api/dashboard/sales",r="api/dashboard/customers",o="api/dashboard/bestsellers",a="api/rest/products",l="api/rest/categories",c="api/rest/subcategories",u="api/rest/orders",d="https://course-js.javascript.ru/",m="https://api.imgur.com/3/image",h="28aaa2e823b03b1",p="ru-RU",g={success:"success",error:"error"}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e="",{duration:t=2e3,type:s=""}={}){this.message=e,this.duration=t,this.type=s,this.render()}render(){this.element=document.createElement("div"),this.element.innerHTML=`\n      <div class="notification notification_${this.type} show">\n        <div class="notification-body notification__content">${this.message}</div>\n      </div>\n    `,this.element=this.element.firstElementChild}show(e=document.body){n.currentNotification&&n.currentNotification.remove(),e.append(this.element),this.timeoutId=setTimeout(()=>{this.remove()},this.duration),n.currentNotification=this}remove(){this.element&&this.element.remove(),clearTimeout(this.timeoutId)}destroy(){this.remove(),this.element=null,n.currentNotification=null}}var i,r,o;o=null,(r="currentNotification")in(i=n)?Object.defineProperty(i,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):i[r]=o},function(e,t,s){"use strict";t.a=async function(e,t){let s,i;try{s=await fetch(e.toString(),t)}catch(e){throw new n(s,"Network error has occurred.")}if(!s.ok){let e=s.statusText;try{i=await s.json(),e=i.error&&i.error.message||i.data&&i.data.error&&i.data.error.message||e}catch(e){}let t=`Error ${s.status}: ${e}`;throw new n(s,i,t)}try{return await s.json()}catch(e){throw new n(s,null,e.message)}};class n extends Error{constructor(e,t,s){var n,i,r;super(s),r="FetchError",(i="name")in(n=this)?Object.defineProperty(n,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[i]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof n&&alert(e.reason.message)})},function(e,t,s){"use strict";t.a=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},,function(e,t,s){"use strict";function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,"a",(function(){return i}));class i{constructor({items:e=[]}){n(this,"element",void 0),n(this,"onPointerDown",e=>{const t=e.target.closest(".sortable-list__item");t&&(e.target.closest("[data-grab-handle]")&&this.startDragging(this.getClientX(e),this.getClientY(e),t),e.target.closest("[data-delete-handle]")&&t.remove())}),n(this,"onPointerMove",e=>{const t=this.element.querySelector(".sortable-list__item.sortable-list__item_dragging");if(!t)return;const s=this.getClientX(e)-this.shiftX,n=this.getClientY(e)-this.shiftY;this.moveAt(s,n,t)}),n(this,"onPointerUp",e=>{const t=this.element.querySelector(".sortable-list__item.sortable-list__item_dragging");t&&this.stopDragging(t)}),this.items=e,this.render(),this.initEventListeners()}render(){this.element=document.createElement("ul"),this.element.classList.add("sortable-list"),this.items.forEach(e=>{e.classList.add("sortable-list__item")}),this.element.append(...this.items)}initEventListeners(){this.element.addEventListener("dragstart",()=>!1),this.element.addEventListener("touchstart",this.onPointerDown),this.element.addEventListener("mousedown",this.onPointerDown),this.element.addEventListener("pointercancel",()=>{alert("pointercancel")})}moveAt(e,t,s){s.style.left=e+"px",s.style.top=t+"px",this.checkMovePlaceholder(t+s.offsetHeight/2)}checkMovePlaceholder(e){const t=this.getPlaceholder(),{top:s,bottom:n}=t.getBoundingClientRect();t.previousElementSibling&&e<s&&t.previousElementSibling.before(t),t.nextElementSibling&&e>n&&t.nextElementSibling.after(t)}startDragging(e,t,s){this.indexFrom=this.getIndex(s);const{left:n,width:i,top:r,height:o}=s.getBoundingClientRect();this.shiftX=e-n,this.shiftY=t-r,s.classList.add("sortable-list__item_dragging"),s.style.width=i+"px",s.style.height=o+"px",s.style.left=n+"px",s.style.top=r+"px",s.after(this.createPlaceholder(i,o)),s.parentElement.append(s),this.addEventListeners()}addEventListeners(){this.element.addEventListener("touchend",this.onPointerUp),this.element.addEventListener("touchmove",this.onPointerMove),this.element.addEventListener("mouseup",this.onPointerUp),this.element.addEventListener("mousemove",this.onPointerMove)}stopDragging(e){this.removeEventListeners(),e.classList.remove("sortable-list__item_dragging"),e.style.cssText="";const t=this.getPlaceholder();t.before(e),t.remove();const s=this.getIndex(e);this.indexFrom!==s&&this.fireCustomEvent(this.indexFrom,s)}removeEventListeners(){this.element.removeEventListener("touchmove",this.onPointerMove),this.element.removeEventListener("touchend",this.onPointerUp),this.element.removeEventListener("mousemove",this.onPointerMove),this.element.removeEventListener("mouseup",this.onPointerUp)}createPlaceholder(e,t){const s=document.createElement("div");return s.classList.add("sortable-list__placeholder"),s.style.width=e+"px",s.style.height=t+"px",s}getPlaceholder(){return this.element.querySelector(".sortable-list__placeholder")}getClientX(e){return e.clientX?e.clientX:e.changedTouches[0].clientX}getClientY(e){return e.clientY?e.clientY:e.changedTouches[0].clientY}getIndex(e){let t=0,s=e;for(;s.previousElementSibling;)s=s.previousElementSibling,t++;return t}fireCustomEvent(e,t){this.element.dispatchEvent(new CustomEvent("list-order-update",{bubbles:!0,detail:{indexFrom:e,indexTo:t}}))}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.element=null}}}]]);
//# sourceMappingURL=5.js.map